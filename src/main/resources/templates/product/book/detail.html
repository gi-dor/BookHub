<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"  xmlns:th="http://thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/base}" >
<th:block layout:fragment="style">
    <link rel="stylesheet" th:href="@{/css/product/bookDetail.css}" />
</th:block>

<div layout:fragment="content" class="container my-3">
    <div class="row mb-3">
        <div class="col-4">
            <div class="mt-5" style="font-weight: bold">
                <span th:each="bookAuthor : ${bookAuthorList}">
                    <div>
                        <span th:if="${bookAuthor.authorType == '지은이'}">
                            <span>저자 : </span>
                            <span th:text="${bookAuthor.author.name}"></span>
                        </span>
                    </div>
                    <div>
                        <span th:if="${bookAuthor.authorType == '옮긴이'}">
                            <span>옮긴이 : </span>
                            <span th:text="${bookAuthor.author.name}"></span>
                        </span>
                    </div>
                </span>
            </div>
            <div style="font-weight: bold">
                <span>출판사 : </span>
                <span th:text="${book.publisher.name}"></span>
            </div>
            <div class="card text-center mt-5" style="width: 18rem;">
                <div class="card-body">
                    <h5 class="card-title" th:text="${book.averageRating}"></h5>
                    <div>
                        <span class="card-text" th:text="${book.reviewCount}"></span>
                        <span>개의 리뷰</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-3">
            <h3 id="book-no" th:text="${book.bookNo}" style="display:none">책 번호</h3>
            <h3 class="d-flex justify-content-center" th:text="${book.name}"><strong>책 제목</strong></h3>

            <div id="carouselExample" class="carousel slide" style="width: 300px; height: 500px; margin: 0 auto;" >
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img th:if="${book.imageCover != 'default.png'}" th:src="${book.imageCover}" class="d-block w-100" alt="...">
                        <img th:if="${book.imageCover == 'default.png'}" src="/image/main/default.png" class="d-block w-100" alt="...">
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <div class="col-5">
            <div class="order-md-last">
                <div class="d-flex justify-content-start align-items-center mb-3">
                    <span class="badge rounded-pill text-bg-dark me-3">베스트셀러</span>
                    <span class="badge rounded-pill text-bg-success">
                            <span th:text="${#numbers.formatDecimal(book.discountRate * 100, 0, 0)}"></span>% 할인
                        </span>
                </div>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0"><strong>가격</strong></h6>
                        </div>
                        <span>
                            <span style="color: forestgreen">
                                <span th:text="${#numbers.formatDecimal(book.discountRate * 100, 0, 0)}"></span>%
                            </span>
                            <strong><span th:text="${#numbers.formatDecimal(book.price * (1 - book.discountRate), 0, 0)}"></span></strong>원
                            <span th:text="${book.price}" style="text-decoration: line-through; color: grey"></span>원
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0"><strong>기본 적립/혜택</strong></h6>
                        </div>
                        <span><span th:text="${#numbers.formatDecimal(book.price * 0.01, 0, 0)}"></span>P</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0"><strong>판매 상태</strong></h6>
                        </div>
                        <div>
                            <div class="badge text-bg-success" th:text="${book.status}"></div><br>
                            <span th:text="${book.stock}"></span>개 남음
                        </div>
                    </li>
                    <li class="list-group-item d-flex justify-content-between bg-light">
                        <div class="text-success">
                            <h6 class="my-0"><strong>배송 안내</strong></h6>
                        </div>
                        <span class="badge text-bg-light">당일 배송</span>
                    </li>
                </ul>

                <form class="card p-2">
                    <div class="input-group">
                        <span class="form-control">품절 상품의 경우 알림신청 시 입고 정보를 받으실 수 있습니다</span>
                        <button type="button" class="btn btn-secondary">알림신청</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <h3 class="mt-5">책 내용</h3>
    <p th:text="${book.description}"></p>

    <!-- 도서 기본정보 -->
    <h3 class="mt-5">기본정보</h3>
    <table class="table">
        <tr th:if="${book.isbn != null}">
            <th>ISBN</th>
            <td th:text="${book.isbn}"></td>
        </tr>
        <tr th:if="${book.publishedDate != null}">
            <th>발행(출시)일자</th>
            <td th:text="${#temporals.format(book.publishedDate, 'yyyy-MM-dd')}"></td>
        </tr>
        <tr th:if="${book.pages != null}">
            <th>쪽수</th>
            <td th:text="${book.pages}"></td>
        </tr>
        <tr th:if="${book.size != null}">
            <th>크기</th>
            <td th:text="${book.size}"></td>
        </tr>
        <tr th:if="${book.totalNumber != null}">
            <th>총권수</th>
            <td th:text="${book.totalNumber}"></td>
        </tr>
    </table>

    <!-- 도서 설명 사진 -->
    <div th:if="${book.imageDescription != null}">
        <img th:src="${book.imageDescription}" class="d-block w-100" alt="...">
    </div>


    <!-- 리뷰 -->
    <div class="row mt-5">
        <div class="col-1"></div>
        <div class="col-3">
            <canvas id="chart-rate-count"></canvas>
        </div>
        <div class="col-2"></div>
        <div class="col-5">
            <canvas id="chart-review-tag-count"></canvas>
        </div>
        <div class="col-1"></div>
    </div>

    <div id="review-block"></div>
    <div class="d-flex justify-content-between mt-5 mb-3">
        <div>
            <input type="radio" class="btn-check" name="radio-option" id="all-reviews" value="total" autocomplete="off"
                   th:checked="${option eq 'total'}" onchange="changeSortOption()">
            <label class="btn" for="all-reviews">전체 리뷰</label>

            <input type="radio" class="btn-check" name="radio-option" id="buyer-reviews" value="buyer" autocomplete="off"
                   th:checked="${option eq 'buyer'}" onchange="changeSortOption()">
            <label class="btn" for="buyer-reviews">구매자 리뷰</label>

            <input type="radio" class="btn-check" name="radio-option" id="my-reviews" value="my" autocomplete="off"
                   th:checked="${option eq 'my'}" onchange="changeSortOption()">
            <label class="btn" for="my-reviews">내 리뷰</label>
        </div>
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-dark me-3" onclick="createReview()" style="width: 100px">리뷰 작성</button>
            <select class="form-select" name="select-sort" onchange="changeSortOption()" th:attr="value=${sort}">
                <option value="date" th:selected="${sort eq 'date'}">최신순</option>
                <option value="recommend" th:selected="${sort eq 'recommend'}">추천순</option>
                <option value="reply" th:selected="${sort eq 'reply'}">댓글순</option>
            </select>
        </div>
    </div>

    <div class="col-12">
        <div id="div-reviews">
            <div th:if="${#lists.size(reviewDtoList) == 0}" class="d-flex justify-content-center">
                <h5 class="mt-5">작성된 리뷰가 없습니다</h5>
            </div>
            <div th:each="review: ${reviewDtoList}">
                <a th:id="|review_${review.reviewNo}|"></a>
                <div class="row g-0 rounded overflow-hidden h-md-250 position-relative border review">
                    <div class="col p-4  position-static">
                        <div class="d-flex justify-content-between">
                                    <span>
                                        <span class="review-no" style="display:none;" th:text="${review.reviewNo}"></span>
                                        <span class="badge rounded-pill text-bg-light">종이책</span>
                                        <span th:if="${review.buyerYn eq 'Y'}">
                                            <span class="badge rounded-pill text-bg-dark">구매자</span>
                                        </span>
                                        <span class="badge bg-light text-dark" th:text="${#strings.substring(review.user.id, 0, 2) + '***'}"></span>
                                        <span class="badge bg-light text-dark" th:text="${#temporals.format(review.updatedDate, 'yyyy-MM-dd HH:mm:ss')}"></span>
                                        <span class="ms-3">신고/차단</span>
                                    </span>
                            <span>
                                        <span th:text="${review.reviewTag.name}"></span>
                                        <span th:text="${review.rate}"></span>
                                         <span>
                                                <a class="btn btn-sm btn-outline-secondary" th:onclick="'createReview(event, ' + ${review.reviewNo} + ')'"
                                                   sec:authorize="isAuthenticated()"
                                                   th:if="${#authentication.principal.username == review.user.id}">수정</a>
                                                <a class="btn btn-sm btn-outline-secondary"  th:href="@{|/product/review/delete/${book.bookNo}/${review.reviewNo}|}"
                                                   sec:authorize="isAuthenticated()"
                                                   th:if="${#authentication.principal.username == review.user.id}">삭제</a>
                                         </span>
                                    </span>
                        </div>
                        <p class="card-text mb-auto mt-3 collapsed " th:id="'cardContent-' + ${review.reviewNo}" th:text="${review.comment}">
                        </p>
                        <div class="d-flex justify-content-between mt-3">
                            <a href="#" class="" th:id="'toggleLink-' + ${review.reviewNo}" th:onclick="'toggleCardContent(event, ' + ${review.reviewNo} + ')'">
                                <i class="bi bi-chevron-double-down"></i>
                            </a>
                            <div>
                                    <span class="recommend">
                                        <span>
                                             <i th:class="${review.recommended == 'Y'} ? 'bi bi-hand-thumbs-up-fill' : 'bi bi-hand-thumbs-up'" th:id="'recommend-' + ${review.reviewNo}"></i>
                                        </span>
                                        <span class="me-3 " th:id="'recommend-count-' + ${review.reviewNo}" th:text="${review.recommendCount}"></span>
                                    </span>
                                <span class="reply">
                                        <i class="bi bi-chat-dots"></i>
                                        <span class="me-3" th:text="${review.replyCount}"></span>
                                    </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto d-none d-lg-block">
                            <span th:if="${review.reviewImageList != null and not #lists.isEmpty(review.reviewImageList)}">
                                <img th:src="@{|/image/product/${review.reviewImageList.get(0).imagePath}|}" alt="리뷰 이미지" style="width: 200px; height: 200px"/>
                            </span>
                    </div>
                    <div class="row" th:id="'review-images-' + ${review.reviewNo}" style="display: none">
                        <span th:if="${review.reviewImageList != null and not #lists.isEmpty(review.reviewImageList)}">
                            <span th:each="reviewImage : ${review.reviewImageList}">
                                 <img th:src="@{|/image/product/${reviewImage.imagePath}|}" alt="리뷰 이미지" style="width: 200px; height: 200px;"/>
                            </span>
                        </span>
                    </div>
                </div>

                <!-- 댓글 목록 및 작성폼 -->
                <div class="row mb-3">
                    <div class="col-12">
                        <!-- 댓글 목록 -->
                        <div th:if="${review.reviewReplyList != null and not #lists.isEmpty(review.reviewReplyList)}">
                            <div th:each="reviewReply: ${review.reviewReplyList}">
                                <a th:id="|reply_${reviewReply.reviewReplyNo}|"></a>
                                <div class="card my-3" id="div-replies">
                                    <div class="card-body py-1 px-2">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <span class="badge bg-light text-dark" th:text="${#strings.substring(reviewReply.user.id, 0, 2) + '***'}"></span>
                                                <span class="badge bg-light text-dark" th:text="${#temporals.format(reviewReply.updatedDate, 'yyyy-MM-dd HH:mm:ss')}">2024-03-21</span>
                                            </div>
                                            <div>
                                                <a class="btn btn-sm btn-outline-secondary modify-reply"
                                                   onclick="modifyReply()"
                                                   sec:authorize="isAuthenticated()"
                                                   th:if="${#authentication.principal.username == reviewReply.user.id}">수정</a>
                                                <a class="btn btn-sm btn-outline-secondary"
                                                   th:href="@{|/product/review/reply/delete?reviewReplyNo=${reviewReply.reviewReplyNo}&reviewNo=${review.reviewNo}&bookNo=${book.bookNo}|}"
                                                   sec:authorize="isAuthenticated()"
                                                   th:if="${#authentication.principal.username == reviewReply.user.id}">삭제</a>
                                            </div>
                                        </div>
                                        <input type="hidden" class="review-reply-no" th:value="${reviewReply.reviewReplyNo}"/>
                                        <p class="card-text ps-2 small reply-comment" style="white-space: pre-line;"
                                           th:text="${reviewReply.comment}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 댓글 작성폼 -->
                        <form class="border p-3 mb-3" th:id="'form-reply-' + ${review.reviewNo}" method="post" action="/product/review/reply/create"
                              style="display: none;">
                            <input type="hidden" name="bookNo" th:value="${book.bookNo}"/>
                            <input type="hidden" name="reviewNo" th:value="${review.reviewNo}"/>
                            <div class="row g-3">
                                <div class="col-12 position-relative">
                                    <textarea rows="3" class="form-control" name="comment"></textarea>
                                    <button type="submit" class="btn btn-outline-dark btn-sm position-absolute"
                                            style="bottom: 15px; right: 25px;" sec:authorize="isAuthenticated()">댓글 등록</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${page.totalPages > 1}">
            <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-center pagination-sm">
                    <!-- 이전 페이지 링크 -->
                    <li class="page-item">
                        <a class="page-link" th:href="@{|/product/book/detail?bookNo=${book.bookNo}|(page=${page.currentPage - 1},sort=${sort},option=${option})}" th:if="${page.currentPage > 1}">이전</a>
                        <span class="page-link disabled" th:unless="${page.currentPage > 1}">이전</span>
                    </li>
                    <!-- 페이지 번호를 표시 -->
                    <li class="page-item" th:each="pageNumber : ${#numbers.sequence(1, page.totalPages)}" th:class="${pageNumber == page.currentPage} ? 'active' : ''">
                        <a class="page-link" th:href="@{|/product/book/detail?bookNo=${book.bookNo}|(page=${pageNumber},sort=${sort},option=${option})}" th:text="${pageNumber}"></a>
                    </li>
                    <!-- 다음 페이지 링크 -->
                    <li class="page-item">
                        <a class="page-link" th:href="@{|/product/book/detail?bookNo=${book.bookNo}|(page=${page.currentPage + 1},sort=${sort},option=${option})}" th:if="${page.currentPage < page.totalPages}">다음</a>
                        <span class="page-link disabled" th:unless="${page.currentPage < page.totalPages}">다음</span>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- 바텀 네비게이션 바 -->
    <nav class="navbar fixed-bottom navbar-light bg-light">
        <div class="container-fluid justify-content-end">
            <div class="btn-group me-2" role="group" aria-label="Second group">
                <a type="button" id="count-minus"
                   class="btn btn-outline-secondary count-minus">-</a>
                <input class="cart-count" name="buyBookCountList" value="1"
                       style="width:30px; border: none;  background-color: transparent; padding: 0; margin: 10px"/>
                <a type="button" id="count-plus"
                   class="btn btn-outline-secondary count-plus">+</a>
            </div>
            <button class="btn btn-outline-secondary me-3"
                    type="button" onclick="toggleAct(this)"
                    sec:authorize="isAuthenticated()">
                <i id="wish-list" th:classappend="${wishListYn == 'Y' ? 'bi bi-heart-fill' : 'bi bi-heart'}"></i>
            </button>
            <button class="btn btn-outline-secondary me-3"
                    type="button" onclick="createOrIncreaseCart()"
                    sec:authorize="isAuthenticated()"
                    th:attr="disabled=${book.stock == 0}">장바구니</button>
            <form method="post" action="/product/gift">
                <input type="hidden" name="buyBookNoList" th:value="${book.bookNo}"/>
                <input type="hidden" name="buyBookCountList" value=1 />
                <button type="submit" class="btn btn-outline-success me-3"
                        sec:authorize="isAuthenticated()"
                        th:attr="disabled=${book.stock == 0}">선물하기</button>
            </form>
            <form method="post" action="/product/buy/order">
                <input type="hidden" name="buyBookNoList" th:value="${book.bookNo}"/>
                <input type="hidden" name="buyBookCountList" value=1 />
                <button type="submit" class="btn btn-outline-success me-3"
                        sec:authorize="isAuthenticated()"
                        th:attr="disabled=${book.stock == 0}">바로 주문</button>
            </form>
        </div>
    </nav>

    <!-- 모달 창 -->
    <div id="modal-move-to-cart" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">상품이 장바구니에 담겼습니다.</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>장바구니로 이동하시겠습니까?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <a type="button" class="btn btn-primary" href="/product/cart">장바구니로 이동</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달 창 -->
    <div id="modal-increase-cart" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">이미 장바구니에 존재하는 상품이라 수량이 추가되었습니다.</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>장바구니로 이동하시겠습니까?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <a type="button" class="btn btn-primary" href="/product/cart">장바구니로 이동</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 리뷰 모달 창 -->
    <div id="modal-create-review" class="modal" tabindex="-1">
        <form method="post" action="/product/review/createOrUpdate" enctype="multipart/form-data">
            <input type="hidden" name="createYn" value="create" />
            <input type="hidden" name="reviewNo" value=0 />
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">리뷰 작성</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="badge text-bg-dark" th:classappend="${buyerYn == 'Y'} ? 'visible' : 'hidden'">구매자 리뷰</span>
                            <input type="hidden" name="buyerYn" th:value="${buyerYn}" />
                        </div>
                        <div class="card mb-3" style="max-width: 540px;">
                            <div class="row g-0">
                                <div class="col-md-4">
                                    <img th:src="${book.imageCover}" class="img-fluid rounded-start" alt="...">
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <input type="hidden" name="bookNo" th:value="${book.bookNo}"/>
                                        <h5 class="card-title" th:text="${book.name}"></h5>
                                        <div class="rate_wrap">
                                            <div class="rate_box">
                                                <label for="rate_1" class="label_star" title="0.5"><span class="blind">0.5점</span></label>
                                                <label for="rate_2" class="label_star" title="1"><span class="blind">1점</span></label>
                                                <label for="rate_3" class="label_star" title="1.5"><span class="blind">1.5점</span></label>
                                                <label for="rate_4" class="label_star" title="2"><span class="blind">2점</span></label>
                                                <label for="rate_5" class="label_star" title="2.5"><span class="blind">2.5점</span></label>
                                                <label for="rate_6" class="label_star" title="3"><span class="blind">3점</span></label>
                                                <label for="rate_7" class="label_star" title="3.5"><span class="blind">3.5점</span></label>
                                                <label for="rate_8" class="label_star" title="4"><span class="blind">4점</span></label>
                                                <label for="rate_9" class="label_star" title="4.5"><span class="blind">4.5점</span></label>
                                                <label for="rate_10" class="label_star" title="5"><span class="blind">5점</span></label>
                                                <input type="radio" name="rate" id="rate_1" class="star_radio" value="0.5">
                                                <input type="radio" name="rate" id="rate_2" class="star_radio" value="1">
                                                <input type="radio" name="rate" id="rate_3" class="star_radio" value="1.5">
                                                <input type="radio" name="rate" id="rate_4" class="star_radio" value="2">
                                                <input type="radio" name="rate" id="rate_5" class="star_radio" value="2.5">
                                                <input type="radio" name="rate" id="rate_6" class="star_radio" value="3">
                                                <input type="radio" name="rate" id="rate_7" class="star_radio" value="3.5">
                                                <input type="radio" name="rate" id="rate_8" class="star_radio" value="4">
                                                <input type="radio" name="rate" id="rate_9" class="star_radio" value="4.5">
                                                <input type="radio" name="rate" id="rate_10" class="star_radio" value="5">
                                                <span class="rate_bg"></span>
                                            </div>
                                        </div>
                                        <p class="card-text"><small class="text-body-secondary">/5</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3"><bold>감성태그</bold></div>
                        <p>가장 와 닿는 하나의 키워드를 선택해주세요.</p>
                        <div class="form-group">
                            <input type="radio" class="btn-check" name="reviewTagNo" id="option1" value=1 autocomplete="off" checked>
                            <label class="btn btn-outline-dark rounded-pill px-3 btn-sm" for="option1">집중돼요</label>

                            <input type="radio" class="btn-check" name="reviewTagNo" id="option2" value=2 autocomplete="off">
                            <label class="btn btn-outline-dark rounded-pill px-3 btn-sm" for="option2">도움돼요</label>

                            <input type="radio" class="btn-check" name="reviewTagNo" id="option3" value=3 autocomplete="off">
                            <label class="btn btn-outline-dark rounded-pill px-3 btn-sm" for="option3">쉬웠어요</label>

                            <input type="radio" class="btn-check" name="reviewTagNo" id="option4" value=4 autocomplete="off">
                            <label class="btn btn-outline-dark rounded-pill px-3 btn-sm" for="option4">재밌어요</label>

                            <input type="radio" class="btn-check" name="reviewTagNo" id="option5" value=5 autocomplete="off">
                            <label class="btn btn-outline-dark rounded-pill px-3 btn-sm" for="option5">유익해요</label>
                        </div>

                        <div class="form-group mt-3">
                            <label for="review-comment" class="form-label"><bold>리뷰 작성</bold></label>
                            <textarea class="form-control custom-textarea" id="review-comment" name="comment" rows="3"></textarea>
                        </div>

                        <div class="form-group mt-3">
                            <label for="formFileMultiple" class="form-label"><bold>사진 첨부(선택)</bold></label>
                            <input type="file" class="form-control" id="formFileMultiple" name="imageList" multiple accept="image/*">
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" class="btn btn-primary">등록</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- 댓글 수정 모달 창 -->
    <div id="modal-modify-reply" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">댓글 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="/product/review/reply/modify">
                    <input type="hidden" id="review-reply-no" name="reviewReplyNo"/>
                    <div class="modal-body">
                        <input type="hidden" name="bookNo" th:value="${book.bookNo}"/>
                        <div class="row g-3">
                            <div class="col-12 position-relative">
                                <textarea id="reply-comment-modify" rows="3" class="form-control" name="comment"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" class="btn btn-primary" >수정</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script layout:fragment="script" type="text/javascript">

    const url = "http://localhost:8080/product/cart"
    let bookNo = parseInt($("#book-no").text());
    const modalMoveToCart = new bootstrap.Modal("#modal-move-to-cart");
    const modalIncreaseCart = new bootstrap.Modal("#modal-increase-cart");
    const modalCreateReview = new bootstrap.Modal("#modal-create-review");
    const modalModifyReply = new bootstrap.Modal("#modal-modify-reply");

    let chartRateCountCanvas = document.getElementById('chart-rate-count');
    let chartReviewTagCountCanvas = document.getElementById('chart-review-tag-count');


    let chartRateCount = new Chart(chartRateCountCanvas, {
        type: 'doughnut',
        data: {
            labels: ['0~1', '1~2', '2~3', '3~4', '4~5'],
            datasets: [
                {
                    label: 'Dataset',
                    data: [10,20,30,40,50],
                    backgroundColor: [
                        'rgb(54, 162, 235)',
                        'rgb(75, 192, 192)',
                        'rgb(255, 205, 86)',
                        'rgb(255, 159, 64)',
                        'rgb(255, 99, 132)',
                    ],
                }
            ]
        },
    });

    let chartReviewTagCount = new Chart(chartReviewTagCountCanvas, {
        type: 'bar',
        data: {
            labels: ['집중돼요', '도움돼요', '쉬웠어요', '재밌어요', '유익해요'],
            datasets: [
                {
                    label: 'Dataset',
                    data: [10,20,30,40,50],
                }
            ]
        },
    });

    $.get("/product/review/rate/" + bookNo, function(data){
        console.log('요청 성공:', data);
        chartRateCount.data.datasets[0].data = data;
        chartRateCount.update();

    }).fail(function(xhr, status, error) {

        console.error('요청 실패:', status, error);
    });

    $.get("/product/review/reviewTag/" + bookNo, function(data){
        console.log('요청 성공:', data);
        chartReviewTagCount.data.datasets[0].data = data;
        chartReviewTagCount.update();

    }).fail(function(xhr, status, error) {

        console.error('요청 실패:', status, error);
    });



    $("#div-reviews").on("click", ".recommend", function(event){
        let reviewNo = $(this).closest(".review").find(".review-no").text();

        $.get("/product/review/recommend/" + reviewNo, function(data){
            console.log('요청 성공:', data);

            let $recommendToggle = $(`#recommend-${reviewNo}`);
            let $recommendCount = $(`#recommend-count-${reviewNo}`);
            let recommendCountNum = parseInt($recommendCount.text());

            if(data == "recommend"){
                $recommendToggle.removeClass('bi-hand-thumbs-up');
                $recommendToggle.addClass('bi-hand-thumbs-up-fill');
                $recommendCount.text(recommendCountNum + 1);
            }
            else if(data == "cancel"){
                $recommendToggle.removeClass('bi-hand-thumbs-up-fill');
                $recommendToggle.addClass('bi-hand-thumbs-up');
                $recommendCount.text(recommendCountNum - 1);
            }
        }).fail(function(xhr, status, error) {

            console.error('요청 실패:', status, error);
        });
    })

    $("#div-reviews").on("click", ".reply", function(event){
        let reviewNo = $(this).closest(".review").find(".review-no").text();
        let formId = "#form-reply-" + reviewNo;
        $(formId).toggle();
    })

    $("#div-replies").on("click", ".modify-reply", function(event){
        let comment = $(this).closest(".card").find(".reply-comment").text();
        $("#reply-comment-modify").text(comment);
        let reviewReplyNo = $(this).closest(".card").find(".review-reply-no").val();
        $("#review-reply-no").val(reviewReplyNo);
        modalModifyReply.show();
    })

    $("#count-minus").click(function(event){
        let prevCount = parseInt($("input[name=buyBookCountList]").val());
        if(prevCount > 1) {
            $("input[name=buyBookCountList]").val(prevCount - 1);
        }
    })

    $("#count-plus").click(async function(event){

        let prevVal = parseInt($("input[name=buyBookCountList]").val());
        try {
            let response = await fetch("/product/book/stock/" + bookNo + "/" + (prevVal + 1));
            let checked = await response.text();
            if (checked === "pass") {
                // 성공 처리
                let nowVal = prevVal + 1;
                $("input[name=buyBookCountList]").val(nowVal);
            } else {
                // 실패 처리
                alert("재고가 부족하여 수량을 증가시킬 수 없습니다");
            }
        } catch (error) {
            console.error("네트워크 오류:", error);
            // 실패 처리
            console.log("수량 체크 실패");
        }
    })

    // 장바구니 추가 시 모달
    function showAlertModal(existOrNot){
        console.log(existOrNot);
        if(existOrNot === "exist"){
            modalIncreaseCart.show();
        }
        else{
            modalMoveToCart.show();
        }
    }

    // 장바구니 추가 비동기
    async function createOrIncreaseCart(){
        let count = $("input[name=buyBookCountList]").val();
        let response = await fetch("/product/cart/create/" + bookNo + "/" + count);
        if(!response.ok){
            console.log("장바구니 추가 실패");
        }

        let jsonData = await response.json();

        if(jsonData.existOrNot === "fail")
            alert("재고가 부족하여 장바구니에 추가할 수 없습니다.");
        else{
            showAlertModal(jsonData.existOrNot);
        }
    }

    // 찜하기 토글 및 비동기
    async function toggleAct(button) {
        let heartIcon = button.querySelector('#wish-list');

        if (heartIcon.classList.contains('bi-heart-fill')) {
            heartIcon.classList.remove('bi-heart-fill');
            heartIcon.classList.add('bi-heart');

            let response = await fetch("/product/wishlist/delete/" + bookNo);
            if(!response.ok){
                console.log("위시리스트 추가 실패");
            }
        } else if(heartIcon.classList.contains('bi-heart')) {
            heartIcon.classList.add('bi-heart-fill');
            heartIcon.classList.remove('bi-heart');

            let response = await fetch("/product/wishlist/create/" + bookNo);
            if(!response.ok){
                console.log("위시리스트 추가 실패");
            }
        }
    }

    // 리뷰 생성 모달 창
    async function createReview(event, reviewNo){
        if (reviewNo) {
            // 수정 폼
            //toggleForm('update');
            resetModifyForm(reviewNo);
        } else {
            // 생성 폼
            //toggleForm('create');
            resetCreateForm();
        }

        modalCreateReview.show();
    }

    // 리뷰 펼치기/접기 토글
    function toggleCardContent(event, id) {
        event.preventDefault();
        event.stopPropagation();

        let cardContent = document.getElementById('cardContent-' + id);
        let toggleLink = document.getElementById('toggleLink-' + id);

        if (cardContent.classList.contains('collapsed')) {
            cardContent.classList.remove('collapsed');
            toggleLink.innerHTML = '<i class="bi bi-chevron-double-up"></i>';
            $("#review-images-" + id).show();
        } else {
            cardContent.classList.add('collapsed');
            toggleLink.innerHTML = '<i class="bi bi-chevron-double-down"></i>';
            $("#review-images-" + id).hide();
        }
    }

    function resetCreateForm(){
        $("input[name=createYn]").val("create");

        document.getElementById('option1').checked = true;
        document.getElementById('option2').checked = false;
        document.getElementById('option3').checked = false;
        document.getElementById('option4').checked = false;
        document.getElementById('option5').checked = false;

        $("#review-comment").val('');

        document.querySelectorAll('input[type="radio"][name="rate"]').forEach(function(radio) {
            radio.checked = false;
        });

        document.querySelector('input[name="rate"][value="' + 5 + '"]').checked = true;
    }

    async function resetModifyForm(reviewNo){
        $("input[name=createYn]").val("modify");
        $("input[name=reviewNo]").val(reviewNo);

        let response = await fetch("/product/review/modify/" + reviewNo);
        if(!response.ok){
            console.log("수정 데이터 불러오기 실패");
        }

        let jsonData = await response.json();
        let review = jsonData;

        document.getElementById('option1').checked = review.reviewTag.reviewTagNo === 1;
        document.getElementById('option2').checked = review.reviewTag.reviewTagNo === 2;
        document.getElementById('option3').checked = review.reviewTag.reviewTagNo === 3;
        document.getElementById('option4').checked = review.reviewTag.reviewTagNo === 4;
        document.getElementById('option5').checked = review.reviewTag.reviewTagNo === 5;

        $("#review-comment").val(review.comment);

        document.querySelector('input[name="rate"][value="' + review.rate + '"]').checked = true;

    }

    function changeSortOption(){
        let sort = document.querySelector("select[name=select-sort]").value;
        let option = document.querySelector("input[name=radio-option]:checked").value;

        let url = window.location.href;

        url = updateQueryStringParameter(url, "page", 1);
        url = updateQueryStringParameter(url, "option", option);
        url = updateQueryStringParameter(url, "sort", sort);
        if(url.indexOf('#') === -1)
            url += "#review-block"

        // 새로운 URL로 페이지 리로드
        window.location.href = url;
    }

    // URL에 쿼리 매개변수 추가 또는 업데이트하는 함수
    function updateQueryStringParameter(uri, key, value) {
        let re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
        let separator = uri.indexOf("?") !== -1 ? "&" : "?";
        // 해시 부분 제거
        let parts = uri.split("#");
        uri = parts[0];
        if (uri.match(re)) {
            return uri.replace(re, "$1" + key + "=" + value + "$2") + (parts.length > 1 ? "#" + parts[1] : "");
        } else {
            return uri + separator + key + "=" + value;
        }
    }

    async function checkStock(){
        let prevVal = parseInt($("input[name=buyBookCountList]").val());
        try {
            let response = await fetch("/product/book/stock/" + bookNo + "/" + (prevVal + 1));
            let checked = await response.text();
            if (checked === "pass") {
                // 성공 처리
                let nowVal = prevVal + 1;
                $(this).siblings('input').val(nowVal);
                updatePrices();
                updateBookCount(cartNo, nowVal);
            } else {
                // 실패 처리
                alert("수량 부족");
            }
        } catch (error) {
            console.error("네트워크 오류:", error);
            // 실패 처리
            console.log("수량 체크 실패");
        }
    }

</script>
</html>
